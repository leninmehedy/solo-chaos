version: '3'

# Taskfile.root.yml contains environment variables and other variables
# Taskfile.chaos.yml contains the chaos-related common tasks

tasks:
  consensus-network-bandwidth:
    desc: Run Network Chaos experiments (limited bandwidth)
    vars:
      NAMESPACE: "{{.SOLO_NAMESPACE}}"
      NODE_NAMES: "{{.NODE_NAMES}}"
      RATE: '{{.RATE | default "1gbps"}}'
      LIMIT: '{{.LIMIT | default 20971520}}'   # LIMIT in bytes (20MB)
      BUFFER: '{{.BUFFER | default 102400}}'   # BUFFER in bytes (100KB)
    cmds:
      - echo "ðŸ”„ Running Network Bandwidth Chaos experiments..."
      - echo "NAMESPACE=${NAMESPACE}, NODE_NAMES=${NODE_NAMES}, UUID=${UUID}"
      - envsubst < {{.TASKFILE_DIR}}/network/consensus-node-bandwidth.yml | kubectl apply -f -
      - echo "âœ… Network Bandwidth Chaos experiments applied."
      - task show-experiment-status NAME="solo-chaos-network-bandwidth-{{.UUID}}" TYPE="NetworkChaos"
    env:
      NAMESPACE: "{{.NAMESPACE}}"
      NODE_NAMES: "{{.NODE_NAMES}}"
      RATE: "{{.RATE}}"
      LIMIT: "{{.LIMIT}}"
      BUFFER: "{{.BUFFER}}"
      UUID: "{{.UUID}}"

  consensus-network-netem:
    desc: Run Network Chaos experiments (network emulation)
    vars:
      NAMESPACE: "{{.NAMESPACE | default .SOLO_NAMESPACE}}"
    cmds:
      - echo "ðŸ”„ Running Network Bandwidth Chaos experiments..."
      - echo "NAMESPACE=${NAMESPACE}, UUID=${UUID}"
      - envsubst < {{.TASKFILE_DIR}}/network/netem-800ms.yml | kubectl apply -f -
      - envsubst < {{.TASKFILE_DIR}}/network/netem-ap-melbourne.yml | kubectl apply -f -
      - envsubst < {{.TASKFILE_DIR}}/network/netem-eu-london.yml | kubectl apply -f -
      - envsubst < {{.TASKFILE_DIR}}/network/netem-us-ohio.yml | kubectl apply -f -
      - echo "âœ… Netem Bandwidth Chaos experiments applied."
      - task show-experiment-status NAME="solo-chaos-network-netem-800ms-{{.UUID}}" TYPE="NetworkChaos"
      - task show-experiment-status NAME="solo-chaos-network-netem-ap-melbourne-{{.UUID}}" TYPE="NetworkChaos"
      - task show-experiment-status NAME="solo-chaos-network-netem-eu-london-{{.UUID}}" TYPE="NetworkChaos"
      - task show-experiment-status NAME="solo-chaos-network-netem-us-ohio-{{.UUID}}" TYPE="NetworkChaos"
    env:
      NAMESPACE: "{{.NAMESPACE}}"
      UUID: "{{.UUID}}"

  deploy-cluster-diagnostics:
    desc: Deploy cluster diagnostics for network testing
    vars:
      REGION: "{{.REGION | default \"us\"}}"
    cmds:
      - echo "ðŸ”„ Deploying cluster diagnostics for region {{.REGION}}..."
      - kubectl apply -f {{.TASKFILE_DIR}}/../dev/k8s/cluster-diagnostics.yaml
      - echo "âœ… Cluster diagnostics deployed"

  exec-cluster-diagnostics:
    desc: Execute into cluster diagnostics pod for manual testing
    vars:
      REGION: "{{.REGION | default \"us\"}}"
      NODE_NAME: "{{.NODE_NAME | default \"node3\"}}"  # node3 is in US region by default
    cmds:
      - echo "ðŸ”— Executing into cluster-diagnostics pod for {{.NODE_NAME}} ({{.REGION}} region)..."
      - echo "ðŸ’¡ Once inside, you can run ping tests to other regions:"
      - echo "  â€¢ ping node1-svc.cluster-diagnostics.svc.cluster.local  # AP region (should show ~200ms)"
      - echo "  â€¢ ping node2-svc.cluster-diagnostics.svc.cluster.local  # EU region (should show ~100ms)" 
      - echo "  â€¢ ping node4-svc.cluster-diagnostics.svc.cluster.local  # High latency (should show ~800ms)"
      - echo "  â€¢ exit  # to exit the pod shell"
      - echo ""
      - kubectl exec -it deployment/cluster-diagnostics-{{.NODE_NAME}} -n cluster-diagnostics -- /bin/bash
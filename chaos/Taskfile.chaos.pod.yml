version: '3'

# Taskfile.root.yml contains environment variables and other variables
# Taskfile.chaos.yml contains the chaos-related common tasks

tasks:
  consensus-pod-failure:
    desc: Run Pod Chaos experiments (failure)
    vars:
      NAMESPACE: "{{.SOLO_NAMESPACE}}"
      NODE_NAMES: "{{.NODE_NAMES}}"
      DURATION: '{{.DURATION | default "30s"}}'
    cmds:
      - echo "üîç Validating environment variables..."
      - "{{.TASKFILE_DIR}}/validate-env.sh --require-namespace --require-node-names"
      - echo "üîÑ Running Pod Failure Chaos experiments..."
      - echo "NAMESPACE=${NAMESPACE}, NODE_NAMES=${NODE_NAMES}, UUID=${UUID}"
      - envsubst < {{.TASKFILE_DIR}}/pod/consensus-node-failure.yml | kubectl apply -f -
      - echo "‚úÖ Pod Failure Chaos experiments applied."
      - task show-experiment-status NAME="solo-chaos-pod-failure-{{.UUID}}" TYPE="PodChaos"
    env:
      NAMESPACE: "{{.NAMESPACE}}"
      NODE_NAMES: "{{.NODE_NAMES}}"
      DURATION: "{{.DURATION}}"
      UUID: "{{.UUID}}"

  consensus-pod-kill:
    desc: Run Pod Chaos experiments (kill)
    vars:
      NAMESPACE: "{{.SOLO_NAMESPACE}}"
      NODE_NAMES: "{{.NODE_NAMES}}"
    cmds:
      - echo "üîç Validating environment variables..."
      - "{{.TASKFILE_DIR}}/validate-env.sh --require-namespace --require-node-names"
      - echo "üîÑ Running Pod Kill Chaos experiments..."
      - echo "NAMESPACE=${NAMESPACE}, NODE_NAMES=${NODE_NAMES}, UUID=${UUID}"
      - envsubst < {{.TASKFILE_DIR}}/pod/consensus-node-kill.yml | kubectl apply -f -
      - echo "‚úÖ Pod Kill Chaos experiments applied."
      - task show-experiment-status NAME="solo-chaos-pod-kill-{{.UUID}}" TYPE="PodChaos"
    env:
      NAMESPACE: "{{.NAMESPACE}}"
      NODE_NAMES: "{{.NODE_NAMES}}"
      UUID: "{{.UUID}}"
